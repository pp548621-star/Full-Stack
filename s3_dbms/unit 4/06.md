# Advanced PL/SQL Features

## 1. Stored Procedures

### 1.1 What is a Procedure?

* A **procedure** is a **named block** of PL/SQL code that performs a specific task.
* It can take **parameters (IN, OUT, IN OUT)** and can be reused.
* Advantage: **modularity, reusability, security**.

ðŸ‘‰ In **CodingGita Portal**:

* A procedure can **insert new student records**.
* A procedure can **update marks** after an exam.

---

### 1.2 Syntax

```sql
CREATE OR REPLACE PROCEDURE procedure_name (parameters)
IS
   -- variable declarations
BEGIN
   -- statements
END;
/
```

### 1.3 Example â€“ Insert Student Procedure

```sql
CREATE OR REPLACE PROCEDURE add_student (
   p_rollno IN Student.RollNo%TYPE,
   p_name   IN Student.Name%TYPE,
   p_sem    IN Student.Semester%TYPE,
   p_city   IN Student.City%TYPE
)
IS
BEGIN
   INSERT INTO Student (RollNo, Name, Semester, City)
   VALUES (p_rollno, p_name, p_sem, p_city);

   DBMS_OUTPUT.PUT_LINE('Student ' || p_name || ' added successfully!');
END;
/
```

**Execution**

```sql
BEGIN
   add_student(201, 'Priyesha', 3, 'Rajkot');
END;
/
```

**Output**

```
Student Priyesha added successfully!
```

---

## 2. Functions

### 2.1 What is a Function?

* A **function** is similar to a procedure but **always returns a value**.
* Can be used in **SQL queries** or inside PL/SQL blocks.

ðŸ‘‰ In **CodingGita Portal**:

* A function can **calculate average marks of a student**.
* A function can **return grade based on marks**.

---

### 2.2 Syntax

```sql
CREATE OR REPLACE FUNCTION function_name (parameters)
RETURN datatype
IS
   -- variable declarations
BEGIN
   -- statements
   RETURN value;
END;
/
```

### 2.3 Example â€“ Function to Get Average Marks

```sql
CREATE OR REPLACE FUNCTION get_avg_marks (
   p_rollno IN Student.RollNo%TYPE
) RETURN NUMBER
IS
   v_avg NUMBER;
BEGIN
   SELECT AVG(Marks) INTO v_avg
   FROM Enrollment
   WHERE RollNo = p_rollno;

   RETURN v_avg;
END;
/
```

**Execution**

```sql
DECLARE
   avg_marks NUMBER;
BEGIN
   avg_marks := get_avg_marks(101);
   DBMS_OUTPUT.PUT_LINE('Average Marks: ' || avg_marks);
END;
/
```

**Output**

```
Average Marks: 88.5
```

---

### 2.4 Example â€“ Function to Return Grade

```sql
CREATE OR REPLACE FUNCTION get_grade (
   p_marks IN NUMBER
) RETURN CHAR
IS
   v_grade CHAR(1);
BEGIN
   IF p_marks >= 90 THEN
      v_grade := 'A';
   ELSIF p_marks >= 75 THEN
      v_grade := 'B';
   ELSIF p_marks >= 60 THEN
      v_grade := 'C';
   ELSE
      v_grade := 'F';
   END IF;

   RETURN v_grade;
END;
/
```

**Execution**

```sql
BEGIN
   DBMS_OUTPUT.PUT_LINE('Grade: ' || get_grade(82));
END;
/
```

**Output**

```
Grade: B
```

---

## 3. Triggers

### 3.1 What is a Trigger?

* A **trigger** is a block of PL/SQL that executes **automatically** when an event occurs.
* Events: `INSERT`, `UPDATE`, `DELETE` on a table.
* Types:

  * **BEFORE** vs **AFTER**
  * **ROW-level** vs **STATEMENT-level**

ðŸ‘‰ In **CodingGita Portal**:

* A trigger can **log every student insertion** into an audit table.
* A trigger can **automatically update last\_modified timestamp** when marks change.

---

### 3.2 Example â€“ BEFORE INSERT Trigger

```sql
CREATE OR REPLACE TRIGGER student_before_insert
BEFORE INSERT ON Student
FOR EACH ROW
BEGIN
   DBMS_OUTPUT.PUT_LINE('Inserting new student: ' || :NEW.Name);
END;
/
```

**Execution**

```sql
INSERT INTO Student VALUES (202, 'Krishna', 2, 'Ahmedabad');
```

**Output**

```
Inserting new student: Krishna
```

---

### 3.3 Example â€“ AFTER UPDATE Trigger

```sql
CREATE OR REPLACE TRIGGER marks_after_update
AFTER UPDATE OF Marks ON Enrollment
FOR EACH ROW
BEGIN
   DBMS_OUTPUT.PUT_LINE('Marks updated for RollNo: ' || :NEW.RollNo ||
                        ', Course: ' || :NEW.CourseID ||
                        ', New Marks: ' || :NEW.Marks);
END;
/
```

**Execution**

```sql
UPDATE Enrollment
SET Marks = 95
WHERE RollNo = 101 AND CourseID = 'CS101';
```

**Output**

```
Marks updated for RollNo: 101, Course: CS101, New Marks: 95
```

---

### 3.4 Example â€“ Audit Table with Trigger

```sql
CREATE TABLE Student_Audit (
   action_date DATE,
   rollno NUMBER,
   action VARCHAR2(20)
);

CREATE OR REPLACE TRIGGER student_audit_trigger
AFTER INSERT OR DELETE ON Student
FOR EACH ROW
BEGIN
   IF INSERTING THEN
      INSERT INTO Student_Audit VALUES (SYSDATE, :NEW.RollNo, 'INSERT');
   ELSIF DELETING THEN
      INSERT INTO Student_Audit VALUES (SYSDATE, :OLD.RollNo, 'DELETE');
   END IF;
END;
/
```

---

## 4. Summary

* **Stored Procedures** â†’ Named PL/SQL blocks that **perform tasks** (no return).
* **Functions** â†’ Same as procedures but **must return a value**.
* **Triggers** â†’ Automatically executed when an event (INSERT/UPDATE/DELETE) occurs.
* In **CodingGita DB**:

  * **Procedures** automate insert/update tasks.
  * **Functions** calculate averages & grades.
  * **Triggers** maintain logs and automate actions.

---

