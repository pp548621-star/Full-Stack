# ðŸ“˜ Unit 3 â€” Assignment 2 

**Domain:** Banking â€” **CodingGita Bank (CGBank)**
**Scope:** Very extensive (60 tasks)

## A) One-time Setup (run first)

> Dialect: ANSI-SQL leaning to MySQL/PostgreSQL. Adjust tiny syntax differences if needed.

```sql
-- Create DB
CREATE DATABASE CGBankDB;
-- MySQL:
USE CGBankDB;

-- Master tables
CREATE TABLE City (
  CityID SERIAL PRIMARY KEY,
  CityName VARCHAR(60) UNIQUE NOT NULL,
  StateName VARCHAR(60) NOT NULL
);

CREATE TABLE Branch (
  BranchID VARCHAR(10) PRIMARY KEY,
  BranchName VARCHAR(80) NOT NULL,
  CityID INT NOT NULL,
  IFSC VARCHAR(15) UNIQUE NOT NULL,
  CONSTRAINT fk_branch_city FOREIGN KEY (CityID) REFERENCES City(CityID)
);

CREATE TABLE Customer (
  CustID INT PRIMARY KEY,
  FullName VARCHAR(80) NOT NULL,
  Email VARCHAR(100) UNIQUE,
  Phone VARCHAR(15) UNIQUE,
  CityID INT NOT NULL,
  KYCVerified BOOLEAN DEFAULT FALSE,
  CONSTRAINT fk_cust_city FOREIGN KEY (CityID) REFERENCES City(CityID),
  CONSTRAINT chk_email_at CHECK (Email IS NULL OR Email LIKE '%@%')
);

CREATE TABLE AccountType (
  AcType VARCHAR(20) PRIMARY KEY,      -- 'SAVINGS','CURRENT','SALARY'...
  MinBalance NUMERIC(10,2) DEFAULT 0 CHECK (MinBalance >= 0),
  InterestRate NUMERIC(5,2) CHECK (InterestRate >= 0)
);

CREATE TABLE Account (
  AcNo BIGINT PRIMARY KEY,
  CustID INT NOT NULL,
  BranchID VARCHAR(10) NOT NULL,
  AcType VARCHAR(20) NOT NULL,
  OpenDate DATE NOT NULL,
  Balance NUMERIC(12,2) DEFAULT 0 CHECK (Balance >= 0),
  Status VARCHAR(10) DEFAULT 'ACTIVE' CHECK (Status IN ('ACTIVE','DORMANT','CLOSED')),
  CONSTRAINT fk_ac_cust FOREIGN KEY (CustID) REFERENCES Customer(CustID),
  CONSTRAINT fk_ac_branch FOREIGN KEY (BranchID) REFERENCES Branch(BranchID),
  CONSTRAINT fk_ac_type FOREIGN KEY (AcType) REFERENCES AccountType(AcType)
);

CREATE TABLE Card (
  CardNo BIGINT PRIMARY KEY,
  AcNo BIGINT NOT NULL,
  CardType VARCHAR(10) CHECK (CardType IN ('DEBIT','CREDIT')),
  IssuedOn DATE NOT NULL,
  Expiry DATE NOT NULL,
  Active BOOLEAN DEFAULT TRUE,
  CONSTRAINT fk_card_ac FOREIGN KEY (AcNo) REFERENCES Account(AcNo)
);

CREATE TABLE Txn (
  TxnID BIGSERIAL PRIMARY KEY,
  AcNo BIGINT NOT NULL,
  TxnDate TIMESTAMP NOT NULL,
  TxnType VARCHAR(10) CHECK (TxnType IN ('CREDIT','DEBIT')),
  Amount NUMERIC(12,2) CHECK (Amount > 0),
  Channel VARCHAR(20) CHECK (Channel IN ('BRANCH','ATM','NETBANK','UPI','NEFT','IMPS')),
  Narrative VARCHAR(120),
  CONSTRAINT fk_txn_ac FOREIGN KEY (AcNo) REFERENCES Account(AcNo)
);

CREATE TABLE Beneficiary (
  BenID BIGSERIAL PRIMARY KEY,
  OwnerAcNo BIGINT NOT NULL,
  BenAcNo BIGINT NOT NULL,
  Nickname VARCHAR(60),
  IFSC VARCHAR(15) NOT NULL,
  Active BOOLEAN DEFAULT TRUE,
  CONSTRAINT fk_ben_owner FOREIGN KEY (OwnerAcNo) REFERENCES Account(AcNo)
);

CREATE TABLE LoanProduct (
  LoanCode VARCHAR(10) PRIMARY KEY,       -- 'HOME','AUTO','EDU'
  Name VARCHAR(60) NOT NULL,
  BaseRate NUMERIC(5,2) NOT NULL CHECK (BaseRate >= 0)
);

CREATE TABLE Loan (
  LoanID BIGSERIAL PRIMARY KEY,
  CustID INT NOT NULL,
  BranchID VARCHAR(10) NOT NULL,
  LoanCode VARCHAR(10) NOT NULL,
  Principal NUMERIC(12,2) CHECK (Principal > 0),
  ROI NUMERIC(5,2) CHECK (ROI >= 0),
  StartDate DATE NOT NULL,
  TenorMonths INT CHECK (TenorMonths BETWEEN 6 AND 480),
  Status VARCHAR(12) CHECK (Status IN ('RUNNING','CLOSED','DEFAULT')),
  CONSTRAINT fk_loan_cust FOREIGN KEY (CustID) REFERENCES Customer(CustID),
  CONSTRAINT fk_loan_branch FOREIGN KEY (BranchID) REFERENCES Branch(BranchID),
  CONSTRAINT fk_loan_code FOREIGN KEY (LoanCode) REFERENCES LoanProduct(LoanCode)
);

CREATE TABLE Repayment (
  PayID BIGSERIAL PRIMARY KEY,
  LoanID BIGINT NOT NULL,
  PayDate DATE NOT NULL,
  Amount NUMERIC(12,2) CHECK (Amount > 0),
  Mode VARCHAR(15) CHECK (Mode IN ('CASH','NEFT','UPI','ACH')),
  CONSTRAINT fk_rep_loan FOREIGN KEY (LoanID) REFERENCES Loan(LoanID)
);

-- Seed data
INSERT INTO City (CityName, StateName) VALUES
('Ahmedabad','Gujarat'),('Surat','Gujarat'),('Vadodara','Gujarat'),
('Rajkot','Gujarat'),('Mumbai','Maharashtra');

INSERT INTO Branch (BranchID, BranchName, CityID, IFSC) VALUES
('CGB001','CGBank Main', 1,'CGBK0001'),
('CGB002','CGBank Surat', 2,'CGBK0002'),
('CGB003','CGBank Baroda',3,'CGBK0003');

INSERT INTO AccountType (AcType, MinBalance, InterestRate) VALUES
('SAVINGS',2000,3.50),('CURRENT',0,0.00),('SALARY',0,3.00);

INSERT INTO Customer (CustID, FullName, Email, Phone, CityID, KYCVerified) VALUES
(1001,'Jenil Shah','jenil@codinggita.in','9000000001',1,TRUE),
(1002,'Mahir Patel','mahir@codinggita.in','9000000002',2,TRUE),
(1003,'Arjun Mehta','arjun@codinggita.in','9000000003',3,FALSE),
(1004,'Yashvi Rao','yashvi@codinggita.in','9000000004',4,TRUE),
(1005,'Neel Joshi','neel@codinggita.in','9000000005',2,TRUE),
(1006,'Krishna Dave','krishna@codinggita.in','9000000006',1,FALSE);

INSERT INTO Account (AcNo, CustID, BranchID, AcType, OpenDate, Balance, Status) VALUES
(800000001001,1001,'CGB001','SAVINGS','2023-04-01',75000,'ACTIVE'),
(800000001002,1002,'CGB002','SAVINGS','2023-06-15',12000,'ACTIVE'),
(800000001003,1003,'CGB003','CURRENT','2022-11-20',230000,'ACTIVE'),
(800000001004,1004,'CGB001','SAVINGS','2024-01-05',5000,'DORMANT'),
(800000001005,1005,'CGB002','SALARY','2024-02-20',35000,'ACTIVE'),
(800000001006,1006,'CGB001','SAVINGS','2025-01-10',900,'ACTIVE');

INSERT INTO Card (CardNo, AcNo, CardType, IssuedOn, Expiry, Active) VALUES
(600000000001,800000001001,'DEBIT','2023-04-10','2028-04-30',TRUE),
(600000000002,800000001002,'DEBIT','2023-06-20','2028-06-30',TRUE),
(600000000003,800000001003,'DEBIT','2022-12-01','2027-12-31',TRUE);

INSERT INTO Txn (AcNo, TxnDate, TxnType, Amount, Channel, Narrative) VALUES
(800000001001,'2025-07-01 10:02','CREDIT',25000,'NEFT','Salary July'),
(800000001001,'2025-07-02 19:40','DEBIT', 3500,'UPI','Groceries'),
(800000001001,'2025-08-01 10:05','CREDIT',26000,'NEFT','Salary Aug'),
(800000001002,'2025-08-05 12:10','DEBIT', 2000,'ATM','Cash withdrawal'),
(800000001003,'2025-08-10 15:00','DEBIT',35000,'NEFT','Vendor payment'),
(800000001005,'2025-08-03 09:30','CREDIT',32000,'NEFT','Salary Aug');

INSERT INTO Beneficiary (OwnerAcNo, BenAcNo, Nickname, IFSC, Active) VALUES
(800000001001,800000001002,'Mahir','CGBK0002',TRUE),
(800000001001,800000001005,'Neel Salary','CGBK0002',TRUE),
(800000001002,800000001001,'Jenil','CGBK0001',TRUE);

INSERT INTO LoanProduct (LoanCode, Name, BaseRate) VALUES
('HOME','Home Loan',8.50),('AUTO','Auto Loan',9.25),('EDU','Education Loan',7.25);

INSERT INTO Loan (CustID, BranchID, LoanCode, Principal, ROI, StartDate, TenorMonths, Status) VALUES
(1001,'CGB001','HOME',3500000,8.75,'2023-05-01',240,'RUNNING'),
(1002,'CGB002','AUTO',  800000,9.50,'2024-03-15',60,'RUNNING'),
(1005,'CGB002','EDU',  500000,7.50,'2024-08-01',84,'RUNNING');

INSERT INTO Repayment (LoanID, PayDate, Amount, Mode) VALUES
(1,'2025-07-05',28500,'ACH'),
(1,'2025-08-05',28500,'ACH'),
(2,'2025-08-10',17000,'NEFT');
```

---

## B) Tasks (60 tasks)

### DDL / Evolving Schema (1â€“10)

1. Add column `PAN VARCHAR(12)` to `Customer` with `UNIQUE` constraint.
2. Add `CHECK` on `Account.Status` to only allow `'ACTIVE','DORMANT','CLOSED'` (already present â€” **show** how youâ€™d add it if missing).
3. Add `DEFAULT 0` to `Account.Balance` (idempotently).
4. Create table `ATM(ATMID SERIAL PRIMARY KEY, BranchID VARCHAR(10) NOT NULL, Location VARCHAR(120) NOT NULL, Active BOOLEAN DEFAULT TRUE, FOREIGN KEY (BranchID) REFERENCES Branch(BranchID))`.
5. Create table `ATMVisit(VisitID BIGSERIAL PRIMARY KEY, ATMID INT NOT NULL, CardNo BIGINT NOT NULL, VisitTime TIMESTAMP NOT NULL, TxnAmount NUMERIC(10,2) DEFAULT 0, FOREIGN KEY (ATMID) REFERENCES ATM(ATMID), FOREIGN KEY (CardNo) REFERENCES Card(CardNo))`.
6. Add column `OverdraftLimit NUMERIC(12,2) DEFAULT 0 CHECK (OverdraftLimit >= 0)` to `Account` (for CURRENT accounts).
7. Create a `VIEW` `v_cust_accounts` showing `CustID, FullName, AcNo, AcType, Balance, Status`.
8. Create a `VIEW` `v_branch_stats` giving per-branch totals: number of accounts and sum of balances.
9. Rename `Loan.Product` to `LoanCode` if your engine had an old column (comment the correct syntax for your DB).
10. Create table `StandingInstruction(SIId BIGSERIAL PRIMARY KEY, FromAc BIGINT NOT NULL, ToAc BIGINT NOT NULL, StartDate DATE NOT NULL, Amount NUMERIC(12,2) CHECK (Amount>0), Frequency VARCHAR(10) CHECK (Frequency IN ('WEEKLY','MONTHLY')), Active BOOLEAN DEFAULT TRUE, FOREIGN KEY (FromAc) REFERENCES Account(AcNo))`.

### DML â€” Inserts/Updates/Deletes (11â€“18)

11. Insert 2 ATMs under `CGB001` and 1 under `CGB002`.
12. Record 5 `ATMVisit` rows, mixing zero-amount balance inquiries and cash withdrawals (positive TxnAmount).
13. Insert two new customers and their SAVINGS accounts with opening balance.
14. Mark account `800000001004` as `ACTIVE` and set `Balance=9000`.
15. Move customer `1006` to `CGB002` by **opening** a new account there; keep old account too.
16. Update `OverdraftLimit=150000` for **all CURRENT** accounts.
17. Delete any `Beneficiary` rows where `Active=FALSE` (first insert one such row, then delete).
18. Insert a `StandingInstruction` from `800000001001` to `800000001005`, monthly, amount `3000`.

### DQL â€” Filtering / Ordering / Projection (19â€“26)

19. List all customers in **Surat** with their phones ordered by `FullName`.
20. Show **top 5** accounts by `Balance` (AcNo, CustID, Balance).
21. Show distinct `Channel` values used in `Txn`.
22. List `Txn` for `AcNo=800000001001` in **July & August 2025**, ordered by date.
23. Show accounts with `Status='DORMANT'` or `Balance<2000`.
24. Show cards expiring in **2027**.
25. Show beneficiaries for owner account `800000001001`.
26. Display branches with their city names (join).

### Constraints (27â€“31)

27. Attempt to insert a duplicate `IFSC` in `Branch`â€”capture the error as a SQL comment.
28. Try inserting a `Customer` with `Email` missing `@`â€”observe `CHECK` failure.
29. Add a `CHECK` to ensure `Card.Expiry > Card.IssuedOn`; test with a failing row then comment the error.
30. Add a `UNIQUE (OwnerAcNo, BenAcNo)` on `Beneficiary` to avoid duplicates; show a duplicate insert failing.
31. Add `CHECK` on `Loan.Status` to only allow `'RUNNING','CLOSED','DEFAULT'` (already presentâ€”document enforcement by a failing insert).

### Functions (Aggregates/String/Numeric/Date) (32â€“40)

32. For each account, show **credits total, debits total, and net** (credits âˆ’ debits).
33. For July-Aug 2025, show **monthly salary inflows** (NEFT with narrative like â€˜Salary %â€™) per account.
34. Show **UPPER(FullName)** and email domain (`SUBSTR` after `@`) for every customer.
35. For each branch, show **number of active cards** (Card.Active=TRUE via Account â†’ Branch).
36. Round all balances to nearest hundred (display only) using `ROUND(Balance,-2)` (Postgres) or a suitable expression.
37. Show `DATEDIFF`/date subtraction: days since each account `OpenDate`.
38. For each loan, compute **EMI approx**: `Principal * (r/12) / (1 - (1+r/12)^(-TenorMonths))` where `r = ROI/100`. (Display only.)
39. For all ATM visits, list **hour-of-day** (`EXTRACT(HOUR FROM VisitTime)`) and count visits per hour.
40. Show accounts where **last credit** (max TxnDate where TxnType='CREDIT') is **older than 60 days** from today.

### Joins (INNER/LEFT/RIGHT/FULL/CROSS/SELF) (41â€“46)

41. INNER JOIN: `Customer â†” Account` to list name, AcNo, AcType, Balance.
42. LEFT JOIN: all customers and their accounts (include customers without accounts).
43. RIGHT/FULL OUTER JOIN (or simulate): list all branches with sum of balances (0 where none).
44. CROSS JOIN: produce all **cityâ€“accounttype** pairs (limited to first 20 rows).
45. SELF JOIN: find **customers in the same city** (avoid duplicate pair orders).
46. Join `Txn` with `Account` **and** `Branch` to show: `TxnID, TxnDate, TxnType, Amount, Channel, AcNo, CustID, BranchID, BranchName`. Order by `TxnDate DESC`.

---

### GROUP BY & HAVING (47â€“51)

47. **Per Branch**: show `BranchID, BranchName, total_txns, total_debit, total_credit` where

* `total_debit = SUM(CASE WHEN TxnType='DEBIT' THEN Amount ELSE 0 END)`
* `total_credit = SUM(CASE WHEN TxnType='CREDIT' THEN Amount ELSE 0 END)`
  Include branches with **at least 1 transaction** (`HAVING COUNT(*) >= 1`).
48. **Per Customer**: show `CustID, FullName, accounts_count, total_balance` (sum over all their accounts).
    Keep only customers with **accounts\_count â‰¥ 2**.
49. **Per AccountType**: show `AcType, accounts_count, avg_balance` (rounded to 2 decimals).
    Keep only account types with **accounts\_count â‰¥ 2** (`HAVING`).
50. **Per City (by CityName)**: show number of **KYC-verified customers**.
    Keep only cities with **KYCVerified count â‰¥ 2**.
51. **Per LoanProduct** (`LoanCode`/`Name`): show **total\_principal** and **avg\_ROI** **for RUNNING loans only**.
    Keep products with **total\_principal â‰¥ 1,000,000**.

---

### Set Operations (52â€“54)

> If your engine lacks `INTERSECT/EXCEPT`, emulate using joins/subqueries.

52. **UNION**: Show a single column `Label` that combines

* All distinct **CityName** from `City`, and
* All distinct **AcType** from `AccountType`.
  (You may add a second column `Src` = 'CITY' or 'ACTYPE' for clarity.)

53. **INTERSECT** (or emulate): Find **CityName(s)** that appear **both**

* as at least one **branchâ€™s city** (via `Branch.CityID â†’ City`), **and**
* as at least one **customerâ€™s city** (`Customer.CityID â†’ City`).
  Output: `CityName`.

54. **EXCEPT/MINUS** (or emulate): List **CityName(s)** that have a **branch** but **no customers**.
    Output: `CityName`.

---

### Subqueries (Simple / Correlated / EXISTS) (55â€“60)

55. **Customer total vs overall average**: List `CustID, FullName, total_balance` for customers whose **total\_balance across all accounts** is **greater than the overall average customer total\_balance**.
    (Compute per-customer totals in a subquery/CTE; compare with the global average.)
56. **Account vs branch average (correlated)**: List `AcNo, Balance, BranchID` for accounts whose **Balance** is **greater than the average account balance in the same branch**.
57. **Loan vs product average (correlated)**: List `LoanID, LoanCode, Principal` for loans whose **Principal** is **greater than the average principal for that same `LoanCode`**.
58. **Customers with no accounts**: Using `NOT EXISTS`, list `CustID, FullName` for customers who **do not have any account**.
59. **Dormant accounts by inactivity**: List `AcNo, BranchID, Balance` for accounts that have **no transactions in the last 90 days** (from `CURRENT_DATE`/`NOW()`), using `NOT EXISTS` (or `MAX(TxnDate)` comparison).
60. **Customers with no beneficiaries**: Using `NOT EXISTS`, list `CustID, FullName` for customers that **own at least one account** but **have never added any row in `Beneficiary`** where `OwnerAcNo` belongs to them.

---
